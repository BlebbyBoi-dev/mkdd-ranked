<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MKDD Ranked Dashboard</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link rel="icon" href="favicon.png">
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#111; color:#fff; }
  header { background:#ff4f00; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; }
  header button { background:teal; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; color:#fff; font-weight:bold; }
  header button:hover { background:#008080cc; }
  main { display:flex; max-width:1200px; margin:20px auto; gap:20px; }
  .left, .right { background:#222; padding:20px; border-radius:10px; }
  .left { flex:2; } .right { flex:1; }
  .card { margin-bottom:20px; }
  input, textarea { width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:none; }
  button.action { background:#4CAF50; padding:10px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; color:#fff; }
  button.action:hover { background:#45a049; }
  img.pfp { width:100px; height:100px; border-radius:50%; display:block; margin-bottom:10px; }
  .message { background:#333; padding:8px; border-radius:6px; margin-bottom:5px; }
</style>
</head>
<body>

<header>
  <h1>MKDD Ranked Dashboard</h1>
  <button onclick="showRunForm()">Submit a Run</button>
</header>

<main>
  <div class="left">

    <!-- Profile Card -->
    <div class="card" id="profileCard">
      <h2>Profile</h2>
      <img id="pfp" class="pfp" src="default-pfp.png" alt="Profile Picture">
      <input type="file" id="pfpInput" accept="image/*">
      <label>Username:</label>
      <input type="text" id="usernameInput" placeholder="Your username">
      <label>Bio:</label>
      <textarea id="bioInput" rows="3"></textarea>
      <label>Status:</label>
      <input type="text" id="statusInput">
      <button class="action" onclick="saveProfile()">Save Profile</button>
    </div>

    <!-- Message Board -->
    <div class="card">
      <h2>Message Board</h2>
      <textarea id="messageInput" rows="2" placeholder="Write a message"></textarea>
      <button class="action" onclick="postMessage()">Post</button>
      <div id="messagesList"></div>
    </div>

    <!-- Submit Run -->
    <div class="card" id="runFormCard" style="display:none;">
      <h2>Submit a Run</h2>
      <label>Track:</label>
      <input type="text" id="trackName">
      <label>Time (seconds):</label>
      <input type="number" step="0.001" id="trackTime">
      <button class="action" onclick="submitRun()">Submit Run</button>
    </div>

  </div>

  <div class="right">
    <div class="card">
      <h2>Top Runs</h2>
      <div id="topRuns"></div>
    </div>
  </div>
</main>

<script>
  // ---------------- Firebase Initialization ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyCaAYUX66q8xfXjNl1oNsXc4VTULaAekjo",
    authDomain: "mkddranked.firebaseapp.com",
    projectId: "mkddranked",
    storageBucket: "mkddranked.firebasestorage.app",
    messagingSenderId: "1077376017994",
    appId: "1:1077376017994:web:efb82652bfd4cbb90f68b3",
    measurementId: "G-M7H7198T7X"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------------- Auth Check ----------------
  auth.onAuthStateChanged(user => {
    if (!user) {
      alert("You must be logged in to view the dashboard!");
      window.location.href = "signin.html";
      return;
    }
    loadProfile();
  });

  // ---------------- Profile ----------------
  function loadProfile() {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    userRef.get().then(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      document.getElementById("usernameInput").value = data.username || "";
      document.getElementById("bioInput").value = data.bio || "";
      document.getElementById("statusInput").value = data.status || "";
      document.getElementById("pfp").src = data.pfp || "default-pfp.png";

      // Load approved runs
      userRef.collection("runs").where("status","==","approved").get().then(snapshot => {
        const runs = [];
        snapshot.forEach(r => runs.push(r.data()));
        displayTopRuns(runs);
      });

      // Load messages if you want (optional)
      // messagesList logic can also fetch from Firestore collection
    });
  }

  function saveProfile() {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    const newUsername = document.getElementById("usernameInput").value.trim();
    const bio = document.getElementById("bioInput").value;
    const status = document.getElementById("statusInput").value;
    const fileInput = document.getElementById("pfpInput");

    if (fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        userRef.set({
          username: newUsername,
          bio,
          status,
          pfp: e.target.result
        }, { merge:true }).then(() => alert("Profile saved!"));
      }
      reader.readAsDataURL(fileInput.files[0]);
    } else {
      userRef.set({ username:newUsername, bio, status }, { merge:true }).then(() => alert("Profile saved!"));
    }
  }

  // ---------------- Message Board ----------------
  function postMessage() {
    const msg = document.getElementById("messageInput").value.trim();
    if (!msg) return;
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    userRef.collection("messages").add({
      message: msg,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById("messageInput").value = "";
      loadMessages(); // optional reload
    });
  }

  function loadMessages() {
    const list = document.getElementById("messagesList");
    list.innerHTML = "";
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    userRef.collection("messages").orderBy("createdAt").get().then(snapshot => {
      snapshot.forEach(doc => {
        const div = document.createElement("div");
        div.className = "message";
        div.innerText = doc.data().message;
        list.appendChild(div);
      });
    });
  }

  // ---------------- Runs ----------------
  function showRunForm() { document.getElementById("runFormCard").style.display = "block"; }

  function submitRun() {
    const track = document.getElementById("trackName").value.trim();
    const time = parseFloat(document.getElementById("trackTime").value);
    if (!track || !time) { alert("Fill both fields!"); return; }

    const srp = Math.max(0, 100 - (time - 60)); // simple SRP formula

    db.collection("users").doc(auth.currentUser.uid)
      .collection("runs").add({
        track,
        time,
        srp,
        status:"pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert("Run submitted! Waiting for moderator approval.");
        document.getElementById("trackName").value = "";
        document.getElementById("trackTime").value = "";
      });
  }

  function displayTopRuns(runs) {
    const panel = document.getElementById("topRuns");
    panel.innerHTML = "";
    if (!runs.length) return;
    const sorted = runs.sort((a,b) => b.srp - a.srp).slice(0,5); // top 5 by SRP
    sorted.forEach(r => {
      const div = document.createElement("div");
      div.innerText = `${r.track} - ${r.time}s (SRP: ${r.srp})`;
      panel.appendChild(div);
    });
  }
</script>

</body>
</html>
