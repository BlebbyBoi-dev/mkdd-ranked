<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<script>
  src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"
  src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"
  src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"

  // Initialize Firebase
  const firebaseConfig = { /* your config */ };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  const dashboardContent = document.getElementById('dashboardContent');

  auth.onAuthStateChanged(user => {
    if (user) {
      // User is logged in
      console.log("Logged in as:", user.email);

      // Use their UID or email as key for localStorage profile
      const currentUser = user.uid; // OR user.email if you prefer
      dashboardContent.style.display = 'block';

      // LOAD PROFILE AND OTHER FUNCTIONS
      loadProfile(currentUser);

      // Attach currentUser to global so other functions can access
      window.currentUser = currentUser;

    } else {
      // Not logged in
      alert("You must be logged in to view the dashboard!");
      window.location.href = 'signin.html';
    }
  });

  // Updated loadProfile
  function loadProfile(userId) {
    let userData = JSON.parse(localStorage.getItem(userId)) || {};
    document.getElementById("bioInput").value = userData.bio || "";
    document.getElementById("statusInput").value = userData.status || "";
    document.getElementById("pfp").src = userData.pfp || "default-pfp.png";
    displayTopRuns(userData.runs || []);
    displayMessages(userData.messages || []);
  }

  function saveProfile() {
    let userData = JSON.parse(localStorage.getItem(window.currentUser)) || {};
    userData.bio = document.getElementById("bioInput").value;
    userData.status = document.getElementById("statusInput").value;
    localStorage.setItem(window.currentUser, JSON.stringify(userData));
    alert("Profile saved!");
  }

  function postMessage() {
    const msg = document.getElementById("messageInput").value.trim();
    if (!msg) return;
    let userData = JSON.parse(localStorage.getItem(window.currentUser)) || {};
    userData.messages = userData.messages || [];
    userData.messages.push(msg);
    localStorage.setItem(window.currentUser, JSON.stringify(userData));
    document.getElementById("messageInput").value = "";
    displayMessages(userData.messages);
  }

  function submitRun() {
    const track = document.getElementById("trackName").value;
    const time = parseFloat(document.getElementById("trackTime").value);
    if (!track || !time) { alert("Fill both fields!"); return; }
    let userData = JSON.parse(localStorage.getItem(window.currentUser)) || {};
    userData.runs = userData.runs || [];
    userData.runs.push({ track, time });
    localStorage.setItem(window.currentUser, JSON.stringify(userData));
    displayTopRuns(userData.runs);
    alert("Run submitted!");
  }

  // Update loadProfile
function loadProfile(userId = currentUser) {
  let userData = JSON.parse(localStorage.getItem(userId)) || {};
  document.getElementById("usernameInput").value = userData.username || "";
  document.getElementById("bioInput").value = userData.bio || "";
  document.getElementById("statusInput").value = userData.status || "";
  document.getElementById("pfp").src = userData.pfp || "default-pfp.png";
  displayTopRuns(userData.runs || []);
  displayMessages(userData.messages || []);
}

// Save profile including username and PFP
function saveProfile() {
  let userData = JSON.parse(localStorage.getItem(currentUser)) || {};

  // Username
  const newUsername = document.getElementById("usernameInput").value.trim();
  if (newUsername) userData.username = newUsername;

  // Bio & status
  userData.bio = document.getElementById("bioInput").value;
  userData.status = document.getElementById("statusInput").value;

  // PFP
  const fileInput = document.getElementById("pfpInput");
  if (fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      userData.pfp = e.target.result; // save as Data URL
      localStorage.setItem(currentUser, JSON.stringify(userData));
      document.getElementById("pfp").src = userData.pfp;
      alert("Profile saved!");
    }
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    localStorage.setItem(currentUser, JSON.stringify(userData));
    alert("Profile saved!");
  }
}

</script>


<link rel="icon" href="favicon.png">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #111;
    color: #fff;
  }

  header {
    background: #ff4f00;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header h1 {
    margin: 0;
  }

  header button {
    background: teal;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
  }

  header button:hover {
    background: #008080cc;
  }

  main {
    display: flex;
    max-width: 1200px;
    margin: 20px auto;
    gap: 20px;
  }

  .left, .right {
    background: #222;
    padding: 20px;
    border-radius: 10px;
  }

  .left {
    flex: 2;
  }

  .right {
    flex: 1;
  }

  .card {
    margin-bottom: 20px;
  }

  input, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: none;
  }

  button.action {
    background: #4CAF50;
    padding: 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
  }

  button.action:hover {
    background: #45a049;
  }

  img.pfp {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: block;
    margin-bottom: 10px;
  }

  .message {
    background: #333;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 5px;
  }

</style>
</head>
<body>

<header>
  <h1>MKDD Ranked Dashboard</h1>
  <button onclick="showRunForm()">Submit a Run</button>
</header>

<main>
  <div class="left">

    <div class="card" id="profileCard">
    <h2>Profile</h2>

    <!-- PFP -->
    <img id="pfp" class="pfp" src="default-pfp.png" alt="Profile Picture">
    <input type="file" id="pfpInput" accept="image/*">

    <!-- Username -->
    <label>Username:</label>
    <input type="text" id="usernameInput" placeholder="Your username">

    <label>Bio:</label>
    <textarea id="bioInput" rows="3"></textarea>
    <label>Status:</label>
    <input type="text" id="statusInput">
    <button class="action" onclick="saveProfile()">Save Profile</button>
  </div>


    <div class="card">
      <h2>Message Board</h2>
      <textarea id="messageInput" rows="2" placeholder="Write a message"></textarea>
      <button class="action" onclick="postMessage()">Post</button>
      <div id="messagesList"></div>
    </div>

    <div class="card" id="runFormCard" style="display:none;">
      <h2>Submit a Run</h2>
      <label>Track:</label>
      <input type="text" id="trackName">
      <label>Time (seconds):</label>
      <input type="number" step="0.001" id="trackTime">
      <button class="action" onclick="submitRun()">Submit Run</button>
    </div>

  </div>

  <div class="right">
    <div class="card">
      <h2>Top Runs</h2>
      <div id="topRuns"></div>
    </div>
  </div>
</main>

<script>
  // LOGIN CHECK
  const currentUser = localStorage.getItem("loggedInUser");
  if (!currentUser) {
    alert("You must be logged in to view the dashboard!");
    window.location.href = "signin.html";
  }

  // LOAD PROFILE
  function loadProfile() {
    const userData = JSON.parse(localStorage.getItem(currentUser)) || {};
    document.getElementById("bioInput").value = userData.bio || "";
    document.getElementById("statusInput").value = userData.status || "";
    document.getElementById("pfp").src = userData.pfp || "default-pfp.png";
    displayTopRuns(userData.runs || []);
    displayMessages(userData.messages || []);
  }

  function saveProfile() {
    let userData = JSON.parse(localStorage.getItem(currentUser)) || {};
    userData.bio = document.getElementById("bioInput").value;
    userData.status = document.getElementById("statusInput").value;
    // For now PFP upload is manual
    localStorage.setItem(currentUser, JSON.stringify(userData));
    alert("Profile saved!");
  }

  // MESSAGE BOARD
  function postMessage() {
    const msg = document.getElementById("messageInput").value.trim();
    if (!msg) return;
    let userData = JSON.parse(localStorage.getItem(currentUser)) || {};
    userData.messages = userData.messages || [];
    userData.messages.push(msg);
    localStorage.setItem(currentUser, JSON.stringify(userData));
    document.getElementById("messageInput").value = "";
    displayMessages(userData.messages);
  }

  function displayMessages(messages) {
    const list = document.getElementById("messagesList");
    list.innerHTML = "";
    messages.forEach(m => {
      const div = document.createElement("div");
      div.className = "message";
      div.innerText = m;
      list.appendChild(div);
    });
  }

  // RUN SUBMISSION
  function showRunForm() {
    document.getElementById("runFormCard").style.display = "block";
  }

  function submitRun() {
    const track = document.getElementById("trackName").value;
    const time = parseFloat(document.getElementById("trackTime").value);
    if (!track || !time) { alert("Fill both fields!"); return; }
    let userData = JSON.parse(localStorage.getItem(currentUser)) || {};
    userData.runs = userData.runs || [];
    userData.runs.push({ track, time });
    localStorage.setItem(currentUser, JSON.stringify(userData));
    displayTopRuns(userData.runs);
    alert("Run submitted!");
  }

  function displayTopRuns(runs) {
    const panel = document.getElementById("topRuns");
    panel.innerHTML = "";
    if (!runs.length) return;
    const sorted = runs.sort((a,b)=>a.time-b.time).slice(0,5);
    sorted.forEach(r => {
      const div = document.createElement("div");
      div.innerText = `${r.track} - ${r.time}s`;
      panel.appendChild(div);
    });
  }

  loadProfile();
</script>

</body>
</html>
